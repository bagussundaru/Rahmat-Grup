name: Build and Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
      
      - name: Create deployment artifact
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp package.json deploy/
          cp package-lock.json deploy/ || true
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            # Variables
            DEPLOY_DIR="/var/www/rahmat-grup"
            SOURCE_DIR="$DEPLOY_DIR/source"
            BACKUP_DIR="$DEPLOY_DIR/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "=== Starting deployment ==="
            echo "Timestamp: $TIMESTAMP"
            
            # Create backup of current dist
            if [ -d "$DEPLOY_DIR/dist" ]; then
              mkdir -p "$BACKUP_DIR"
              cp -r "$DEPLOY_DIR/dist" "$BACKUP_DIR/dist_$TIMESTAMP"
              echo "✓ Backup created: $BACKUP_DIR/dist_$TIMESTAMP"
            fi
            
            # Update source repository
            if [ ! -d "$SOURCE_DIR" ]; then
              git clone https://github.com/bagussundaru/Rahmat-Grup.git "$SOURCE_DIR"
              echo "✓ Repository cloned"
            else
              cd "$SOURCE_DIR"
              git fetch origin
              git reset --hard origin/main
              echo "✓ Repository updated to latest main"
            fi
            
            # Build application
            cd "$SOURCE_DIR"
            npm ci
            npm run build
            echo "✓ Application built successfully"
            
            # Deploy dist folder
            rm -rf "$DEPLOY_DIR/dist"
            cp -r "$SOURCE_DIR/dist" "$DEPLOY_DIR/dist"
            sudo chown -R www-data:www-data "$DEPLOY_DIR/dist"
            echo "✓ Dist folder deployed"
            
            # Verify Nginx configuration and reload
            sudo nginx -t && sudo systemctl reload nginx
            echo "✓ Nginx reloaded successfully"
            
            # Cleanup old backups (keep last 5)
            cd "$BACKUP_DIR" 2>/dev/null && ls -1d dist_* 2>/dev/null | sort -r | tail -n +6 | xargs -r rm -rf
            echo "✓ Old backups cleaned up"
            
            echo "=== Deployment completed successfully ==="
      
      - name: Deployment notification
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "App is live at: https://rahmat-grup.web.id"
      
      - name: Deployment failure notification
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          exit 1
